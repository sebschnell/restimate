{
    "collab_server" : "",
    "contents" : "rm(list = ls());\nsetwd(\"C:/Users/Sebastian Schnell/Documents/LiDAR_Satellite\");\n\nlibrary(\"data.table\");\nlibrary(\"ggplot2\");\nlibrary(\"restimate\");\n\n# Simulation parameters ---------------------------------------------------\n\n# db <- dbConnect(SQLite(), dbname = \"E:/data/LiDAR_Satellite/population/pop.sqlite\");\n# dt_pop <- data.table(dbGetQuery(conn = db, \"SELECT row, col, agb, h_mean, p_all_gt_150, id_mun FROM Population\"));\n# dbDisconnect(db);\n\ndt_pop <- readRDS(\"data/population/pop.RDS\");\ndt_pop[, mean_5x5 := NULL];\ndt_pop[, bright := NULL];\ndt_pop[, B8 := NULL];\ndt_pop[, B6 := NULL];\ndt_pop[, B4 := NULL];\ndt_pop[, B3 := NULL];\ndt_pop[, h_p50 := NULL];\ndt_pop[, h_p10 := NULL];\ndt_pop[, sat_h_mean := NULL];\ndt_pop[, sat_h_p95 := NULL];\ndt_pop[, sat_p_all_gt_150 := NULL];\nsetkey(dt_pop, col, row);\n\n# Population parameters\nN <- nrow(dt_pop);\n\nt <- dt_pop[, sum(agb)];\n\n# Add dummy variables\ndt_pop[, ':='(d1 = 1L,\n              d2 = ifelse(id_mun == 2, 1L, 0L),\n              d3 = ifelse(id_mun == 3, 1L, 0L),\n              d4 = ifelse(id_mun == 4, 1L, 0L))]\ndt_pop[, id_mun := as.factor(id_mun)];\nsetkey(dt_pop, id_mun);\n\ndt_strat <- dt_pop[, list(t = sum(agb),\n                          d1 = mean(d1),\n                          d2 = mean(d2),\n                          d3 = mean(d3),\n                          d4 = mean(d4),\n                          h_mean = mean(h_mean),\n                          h_mean_p_all = mean(h_mean*p_all_gt_150),\n                          N_a = .N),\n                   keyby = id_mun];\ndt_strat <- rbind(dt_pop[, list(id_mun = 0,\n                                t = sum(agb),\n                                d1 = mean(d1),\n                                d2 = mean(d2),\n                                d3 = mean(d3),\n                                d4 = mean(d4),\n                                h_mean = mean(h_mean),\n                                h_mean_p_all = mean(h_mean*p_all_gt_150),\n                                N_a = .N)],\n                  dt_strat);\nsetkey(dt_strat, id_mun);\n\n\n# Systematic sample\nn <- 400L; # Number of SSU's allocated over selected PSU's\nh <- 5L; # Number of strata\nM <- 10000L; # Number simulation steps\nsys <- readRDS(file = \"R/simulation/sys_sample_stage2.RDS\");\na_psu <- length(sys);\na_ssu <- length(sys[[1]]);\n\n\ndt_samp_dstrb <- data.table(id = rep(seq.int(a_psu*a_ssu), each = 5L),\n                            id_mun = rep(0L:4L, a_psu*a_ssu),\n                            t_srs = rep(0.0, a_psu*a_ssu*h),\n                            v_srs = rep(0.0, a_psu*a_ssu*h),\n                            t_ma = rep(0.0, a_psu*a_ssu*h),\n                            v_ma = rep(0.0, a_psu*a_ssu*h),\n                            t_mb = rep(0.0, a_psu*a_ssu*h),\n                            v_mb = rep(0.0, a_psu*a_ssu*h),\n                            v_mb_het = rep(0.0, a_psu*a_ssu*h));\n\n# dt_model_param <- data.table(id = seq.int(M),\n#                              id_mun1 = rep(0.0, M),\n#                              id_mun2 = rep(0.0, M),\n#                              id_mun3 = rep(0.0, M),\n#                              id_mun4 = rep(0.0, M),\n#                              h_mean = rep(0.0, M),\n#                              h_mean_p_all = rep(0.0, M));\n#\n# dt_model_pred <- data.table(id = rep(seq.int(M), n),\n#                             obs = rep(0.0, M*n),\n#                             pred = rep(0.0, M*n));\n\ncount <- 0L;\npb <- txtProgressBar(min = 0, max = a_psu*a_ssu, style = 3)\nfor (s1 in seq.int(a_psu)) {\n  for (s2 in seq.int(a_ssu)) {\n    dt_s <-  dt_pop[.(sys[[s1]][[s2]])];\n\n    agb_model <- lm(agb ~ id_mun + h_mean + h_mean:p_all_gt_150, data = dt_s, x = TRUE);\n    b <- coef(agb_model);\n    dt_s[, ':='(pred = fitted.values(agb_model),\n                res = residuals(agb_model))];\n\n    # Predict strata totals\n    dt_strat[, t_pred := as.matrix(dt_strat[, list(d1, d2, d3, d4, h_mean, h_mean_p_all)])%*%b*dt_strat[, N_a]]\n\n    setkey(dt_s, id_mun);\n    dt_s <- dt_s[dt_strat[id_mun != 0, list(id_mun, t_pred, N_a)]];\n\n    # Horvitz-Thompson estimation\n    srs <- list(id_mun = 0L,\n                t_hat = est_tot_ht(y = dt_s[, agb], prob = 1/(a_psu*a_ssu))[1],\n                v_hat = est_var_srswor(y = dt_s[, agb], n = nrow(dt_s), N = N));\n\n    dt_srs_tot <- dt_s[,\n                       list(t_hat = est_tot_ht(y = agb, prob = 1/(a_psu*a_ssu), Nd = max(N_a))[1]),\n                       keyby = id_mun]\n    dt_srs_var <- dt_s[,\n                       list(v_hat = est_var_srswor(y = agb, n = nrow(dt_s), N = N, Nd = max(N_a))),\n                       keyby = id_mun];\n\n    dt_srs <- rbind(srs,\n                    dt_srs_tot[dt_srs_var]);\n\n\n    # Model-assisted estimation\n    ma <- list(id_mun = 0L,\n               t_hat = est_tot_ma(t_pred = dt_strat[id_mun == 0, t_pred],\n                                  prob = 1/(a_psu*a_ssu),\n                                  res = dt_s[, res])[1],\n               v_hat = est_var_srswor_ma(res = dt_s[, res], N = N));\n\n    dt_ma_tot <- dt_s[,\n                      list(t_hat = est_tot_ma(t_pred = max(t_pred), prob = 1/(a_psu*a_ssu), res = res)[1]),\n                      keyby = id_mun];\n    dt_ma_var <- dt_s[,\n                      list(v_hat = est_var_srswor_ma(res = res, N = max(N_a))),\n                      keyby = id_mun];\n\n    dt_ma <- rbind(ma,\n                   dt_ma_tot[dt_ma_var]);\n\n    # Model-based estimation\n    dt_mb <- dt_strat[, list(id_mun, t_pred)];\n    vcov_het_cons <- vcov_white(X = as.matrix(dt_s[, list(d1, d2, d3, d4, h_mean, h_mean*p_all_gt_150)]),\n                                res = dt_s[, res]);\n    mb_var <- list(v_hat = est_var_mb(cov = vcov_het_cons,\n                                      X = as.matrix(dt_strat[id_mun == 0, list(d1, d2, d3, d4, h_mean, h_mean_p_all)])),\n                   v_hat_het = est_var_mb(cov = vcov(agb_model),\n                                          X = as.matrix(dt_strat[id_mun == 0, list(d1, d2, d3, d4, h_mean, h_mean_p_all)])));\n    dt_mb_var <- rbind(data.table(id_mun = 0, v_hat = mb_var$v_hat, v_hat_het = mb_var$v_hat),\n                       dt_strat[id_mun != 0,\n                                list(v_hat = est_var_mb(cov = vcov(agb_model),\n                                                        X = as.matrix(.SD[, list(d1, d2, d3, d4, h_mean, h_mean_p_all)])),\n                                     v_hat_het = est_var_mb(cov = vcov_het_cons,\n                                                            X = as.matrix(.SD[, list(d1, d2, d3, d4, h_mean, h_mean_p_all)]))),\n                                keyby = id_mun]);\n    setkey(dt_mb_var, id_mun);\n    setkey(dt_mb, id_mun);\n    dt_mb <- dt_mb[dt_mb_var];\n    dt_mb[, v_hat := v_hat*dt_strat[, N_a^2]];\n    dt_mb[, v_hat_het := v_hat_het*dt_strat[, N_a^2]];\n\n    # Store results\n    r_start <- count*h + 1L;\n    r_end <- r_start + h - 1L;\n    set(dt_samp_dstrb,\n        r_start:r_end,\n        3L:9L,\n        list(t_srs = dt_srs[, t_hat], v_srs = dt_srs[, v_hat],\n             t_ma = dt_ma[, t_hat], v_ma = dt_ma[, v_hat],\n             t_mb = dt_mb[, t_pred], v_mb = dt_mb[, v_hat],\n             v_mb_het = dt_mb[, v_hat_het]));\n    # r_start <- count*n + 1L;\n    # r_end <- r_start + n - 1L;\n    # set(dt_model_pred,\n    #     r_start:r_end,\n    #     2L:3L,\n    #     list(obs = dt_s[, agb],\n    #          pred = dt_s[, pred]));\n    # set(dt_model_param,\n    #     m,\n    #     2L:7L,\n    #     as.list(b));\n    count <- count + 1L;\n    setTxtProgressBar(pb, count);\n  }\n}\nclose(pb);\n\n# Save results\nout_path <- \"R/simulation/results/\";\nif (file.exists(paste(out_path, \"one_stage_srs_dstrb.csv\", sep = \"\")) == FALSE) {\n  saveRDS(dt_samp_dstrb, file = paste(out_path, \"one_stage_sys_dstrb.RDS\", sep = \"\"));\n  saveRDS(dt_model_param, file = paste(out_path, \"one_stage_srs_param.RDS\", sep = \"\"));\n  saveRDS(dt_model_pred, file = paste(out_path, \"one_stage_srs_pred.RDS\", sep = \"\"));\n} else {\n  warning(\"File exists!\");\n}\n\ndt_samp_dstrb <- readRDS(paste(out_path, \"one_stage_srs_dstrb.RDS\", sep = \"\"));\n\ndt_samp_dstrb[id_mun == 0,\n              list((mean(t_mb) - t)/t*100,\n              sqrt(var(t_mb))/mean(t_mb)*100,\n              sqrt(mean(v_mb))/mean(t_mb)*100)]\n\n\n\n\n## Accuracy of Monte Carlo simulation\n# Check normality of the distribution of t_hat\n# Skewness of the sample distribution\ndt_samp_dstrb <- dt_samp_dstrb[t_hat != 0];\nlibrary(e1071);\ndt_samp_dstrb[, skewness(t_hat), by = id_mun];\n\n# Density of normal distribution compared to observed values\ndt_samp_dstrb[,\n              t_norm := dnorm(t_hat,\n                              mean = mean(t_hat),\n                              sd = sd(t_hat)),\n              by = id_mun];\n\nggplot(dt_samp_dstrb, aes(t_hat)) +\n  geom_histogram(aes(y = ..density..), fill = \"grey\", colour = \"black\") +\n  geom_line(aes(y = t_norm)) +\n  facet_wrap( ~ id_mun, scales = 'free');\n\n# qq-plots\ndt_qq_line <- dt_samp_dstrb[, list(y25 = quantile(t_hat, 0.25),\n                                   y75 = quantile(t_hat, 0.75),\n                                   x25 = qnorm(0.25),\n                                   x75 = qnorm(0.75)),\n                            by = id_mun];\ndt_qq_line[, slope := (y75 - y25)/(x75 - x25), by = id_mun];\ndt_qq_line[, int := y25 - slope*x25, by = id_mun];\n\nggplot(dt_samp_dstrb, aes(sample = t_hat)) +\n  stat_qq() +\n  geom_abline(data = dt_qq_line, aes(intercept = int, slope = slope)) +\n  facet_wrap( ~ id_mun, scales = 'free');\n\n# Correlation between t_hat and v_hat\ndt_samp_dstrb[, cor(t_hat, v_hat), by = id_mun];\n\nalpha <- 0.975;\nz <- qnorm(p = alpha);\ndt_samp_dstrb[, ci := z * sqrt(v_hat)];\ndt_samp_dstrb[, ':='(t_hat_low = t_hat - ci,\n                     t_hat_up = t_hat + ci)];\n\nsetkey(dt_samp_dstrb, id_mun);\ndt_samp_dstrb <- dt_samp_dstrb[dt_strat];\ndt_sim_res <- dt_samp_dstrb[,\n                            list(t_emp = mean(t_hat),\n                                 v_emp = var(t_hat, na.rm = TRUE),\n                                 v_ana = mean(v_hat, na.rm = TRUE),\n                                 n_cover = sum((t >= t_hat_low & t <= t_hat_up), na.rm = TRUE),\n                                 n_low = sum(t_hat_up < t, na.rm = TRUE),\n                                 n_up = sum(t_hat_low > t, na.rm = TRUE),\n                                 p2.5 = sqrt(quantile(v_hat, 0.25, na.rm = TRUE)),\n                                 p97.5 = sqrt(quantile(v_hat, 0.975, na.rm = TRUE))),\n                            keyby = id_mun];\ndt_sim_res <- dt_sim_res[dt_strat];\ndt_sim_res[, bias := t_emp - t];\ndt_sim_res[, RMSE := sqrt(bias^2 + sqrt(v_emp)^2)];\ndt_sim_res[, ':='(cv_emp = sqrt(v_emp)/t * 100,\n                  cv_ana = sqrt(v_ana)/t * 100,\n                  bias_rel = bias/t * 100,\n                  RRMSE = RMSE/t * 100,\n                  v_bias = (v_ana - v_emp)/v_emp * 100,\n                  cr = n_cover/(M),\n                  fr_below = n_low/(M),\n                  fr_up = n_up/(M))];\n\n\ndt_samp_dstrb[, v_cum := cumsum(v_mb_het)/id, by = id_mun];\nggplot(dt_samp_dstrb, aes(x = id, y = v_cum)) +\n  geom_line() +\n  #  geom_hline(aes(yintercept = t), dt_strat) +\n  facet_wrap(~ id_mun, scales = 'free');\n\n\n# Export to clipboard (Excel)\nwrite.table(DtSimRes,\n            \"clipboard\",\n            sep = \"\\t\",\n            col.names = FALSE,\n            row.names = FALSE);\n\n\n\n\n\n",
    "created" : 1474923896813.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "650473413",
    "id" : "94CFCB3B",
    "lastKnownWriteTime" : 1474953028,
    "last_content_update" : 1474953028433,
    "path" : "~/LiDAR_Satellite/R/simulation/one_stage_sys.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}