{
    "collab_server" : "",
    "contents" : "#' Internal helper function to prepare data from a two-stage sample for\n#' estimation by other functions\n#'\n#' @param dt_samp A data.table object containing information about the PSUs and\n#'   SSUs selected in the two sampling stages.\n#' @param key_var Name of the variable identifying the PSUs.\n#' @param y Quoted name of the variable storing the observed values of the study\n#'   variable\n#' @param res Quoted name of the variable under which residuals between observed\n#'   and predicted values are stored. Optional in case of model-assisted\n#'   estimation\n#'\n#' @return A data.table object containing PSU summaries needed for estimation by\n#'   other functions.\n#' @import data.table\nget_psu_stats <- function(dt_samp, id_psu, y, res = NULL) {\n  dt_psu <- dt_samp[,\n                    list(sum_y = sum(eval(y), na.rm = TRUE),\n                         var_y = var(eval(y), na.rm = TRUE)),\n                    keyby = id_psu];\n  dt_psu[is.na(var_y) == TRUE, var_y := 0];\n\n  if (is.null(res) == FALSE) {\n    dt_psu <- dt_psu[dt_samp[,\n                             list(sum_res = sum(eval(res), na.rm = TRUE),\n                                  var_res = var(eval(res), na.rm = TRUE)),\n                             keyby = id_psu]];\n    dt_psu[is.na(var_res) == TRUE, var_res := 0];\n  }\n  return(dt_psu);\n}\n\n#' Succesive difference estimator to estimate variance of a systematic sample\n#'\n#' @param y Observations\n#' @param N Population size\n#' @param n Sample size\n#' @param w Weights in case systematic sampling of clusters of unequal size is\n#'   applied. See details for how they are calculated.\n#'\n#' @details For the unweighted version, see the \\eqn{v_4}-estimator in Wolter\n#'   (2003, chapter 8.3). For the weighted version and the case of cluster of\n#'   unequal size, see Nelson et al. (2008, Equation 3). The cluster weights are\n#'   defined as \\deqn{W_i = N_i(\\sum_{i=1}^{n-1}N_i),} where \\eqn{N_i} denotes\n#'   the size of a cluster and \\eqn{n} is the number of clusters selected into\n#'   the sample.\n#' @return An atomic vector with the variance estimate.\n#' @references Nelson, R., Easset, T. Gobakken, G. Stahl and T. G. Gregoire\n#' (2008). \"Regional Forest Inventory using an Airborne Profiling LiDAR.\"\n#' Journal of Forest Planning 13: 287-294.\n#'\n#' Wolter, K. (2003). Introduction to Variance Estimation, Springer.\n#'\n#' @export\nest_var_succ_diff <- function(y, N, n, w = NULL) {\n  y_b <- data.table::shift(y, n = 1, type = 'lag');\n  y_a <- data.table::shift(y, n = 1, type = 'lead');\n  y_succ <- (y_b - 2*y + y_a)^2;\n\n  if (is.null(w) == TRUE) {\n    v_hat <- (1 - n/N)*n/(96*(n - 2))*sum(y_succ, na.rm = TRUE);\n  } else {\n    w_b <- data.table::shift(w, n = 1, type = 'lag');\n    w_a <- data.table::shift(w, n = 1, type = 'lead');\n    w_succ <- (w_b + 2*w + w_a)^2;\n    v_hat <- (1 - n/N)*n/(96*(n - 2))*sum(w_succ*y_succ, na.rm = TRUE);\n  }\n  return(v_hat);\n}\n\n#'Model assisted estimators for two-stage systematic sampling\n#'\n#'The population is separated into a set of contiguous PSUs (clusters/strips),\n#'which are sampled in the first stage. SSUs are selected systematically across\n#'the selected PSUs in the second stage. The estimators correspond to case C in\n#'Särndal et al. (1992) adapted to systematic sampling, where auxiliaries are\n#'avalaible for SSUs in the selected PSUs. Modelling is done at the element\n#'level.\n#'\n#'@param dt_sample A data.table object containing information about the PSUs and\n#'  SSUs selected in the two sampling stages.\n#'@param id_psu Name of the variable identifying the PSUs. Must be present in\n#'  both data.tables.\n#'@param y Quoted name of the variable storing the observed values of the study\n#'  variable.\n#'@param res Quoted name of the variable stroing the residuals between observed\n#'  and predicted values.\n#'@param t_pred Quoted name of the variable storing predicted PSU totals\n#'@param a_psu PSU intervall, every a-th PSU is selected into the sample.\n#'@param a_ssu SSU intervall, every a-th SSU is selected into the sample.\n#'@param NI Number of PSUs\n#'@param nI PSU sample size\n#'@param N_i Optional. PSU size in case PSUs are of different size. Needed for\n#'  the successive differences variance estimator.\n#'\n#'@details See Särndal et al. (1992), equations 8.9.7 for the estimation of\n#'  the population total, slightly adapted to case of systematic sampling. See\n#'  Ene et al. (2016, equation 13) for variance estimation using successive\n#'  differences.\n#'\n#'@return A named list containing estimates for the total and its variance\n#'  estimate\n#'\n#'@references\n#'  Ene, L. T., E. Næsset and T. Gobakken (2016). \"Simulation-based assessment\n#'  of sampling strategies for large-area biomass estimation using wall-to-wall\n#'  and partial coverage airborne laser scanning surveys.\" Remote Sensing of\n#'  Environment 176: 328-340.\n#'\n#'  Särndal, C. E., B. Swensson and J. Wretman (1992). Model assisted survey\n#'  sampling. New York, Springer-Verlag.\n#'\n#'@import data.table\n#'@export\nest_ts_ma_sys <- function(dt_samp, id_psu = 'id', y = quote(y),\n                          res = quote(res), t_pred = quote(t_pred),\n                          a_psu, a_ssu, NI, nI, N_i = quote(N_i)) {\n\n  dt_psu <- get_psu_stats(dt_samp = dt_samp, y = y, id_psu = id_psu, res = res);\n  dt_psu <- dt_psu[dt_samp[, list(t_pred = max(eval(t_pred)),\n                                  N_i = max(eval(N_i))),\n                           keyby = id_psu]];\n\n  dt_psu[, ':='(t_res = a_ssu*sum_res,\n                w_i = N_i/sum(N_i))];\n  dt_psu[is.na(t_res) == TRUE, t_res := 0];\n  dt_psu[, t_hat_ma := t_pred + t_res];\n  dt_psu[, mean_hat_ma := t_hat_ma/N_i];\n\n  # Equation 8.9.7 in Särndal et al. (1992), slightly adapted\n  t_hat <- a_psu * dt_psu[, sum(t_hat_ma)];\n\n  # Equation 13 in Ene et al. (2016)\n  v_hat <- dt_psu[, est_var_succ_diff(y = mean_hat_ma, N = NI, n = nI, w = w_i)];\n\n  return(list(t_hat = t_hat, v_hat = v_hat));\n}\n\n#'The population is separated into a set of contiguous PSUs (clusters/strips),\n#'which are sampled in the first stage. SSUs are selected systematically across\n#'the selected PSUs in the second stage. Adapted to systematic sampling.\n#'\n#'@param dt_sample A data.table object containing information about the PSUs and\n#'  SSUs selected in the two sampling stages.\n#'@param id_psu Name of the variable identifying the PSUs. Must be present in\n#'  both data.tables.\n#'@param y Quoted name of the variable storing the observed values of the study\n#'  variable.\n#'@param a_psu PSU intervall, every a-th PSU is selected into the sample.\n#'@param a_ssu SSU intervall, every a-th SSU is selected into the sample.\n#'@param NI Number of PSUs\n#'@param nI PSU sample size\n#'@param N_i Optional. PSU size in case PSUs are of different size. Needed for\n#'  the successive differences variance estimator.\n#'\n#'@details See Särndal et al. (1992), equations 4.3.21 for the estimation of\n#'  the population total, slightly adapted to case of systematic sampling. See\n#'  Ene et al. (2016, equation 13) for variance estimation using successive\n#'  differences.\n#'\n#'@return A named list containing estimates for the total and its variance\n#'  estimate\n#'\n#'@references\n#'  Ene, L. T., E. Næsset and T. Gobakken (2016). \"Simulation-based assessment\n#'  of sampling strategies for large-area biomass estimation using wall-to-wall\n#'  and partial coverage airborne laser scanning surveys.\" Remote Sensing of\n#'  Environment 176: 328-340.\n#'\n#'  Särndal, C. E., B. Swensson and J. Wretman (1992). Model assisted survey\n#'  sampling. New York, Springer-Verlag.\n#'\n#'@import data.table\n#'@export\nest_ts_sys <- function(dt_samp, id_psu = 'id', y = quote(y),\n                       a_psu, a_ssu, NI, nI, N_i = quote(N_i)) {\n\n  dt_psu <- get_psu_stats(dt_samp = dt_samp, y = y, id_psu = id_psu);\n  dt_psu <- dt_psu[dt_samp[, list(t_pred = max(eval(t_pred)),\n                                  N_i = max(eval(N_i))),\n                           keyby = id_psu]];\n\n  dt_psu[, ':='(t_hat = a_ssu*sum_y,\n                w_i = N_i/sum(N_i))];\n  dt_psu[, mean_t_hat := t_hat/N_i];\n\n  # Equation 8.9.7 in Särndal et al. (1992), slightly adapted\n  t_hat <- a_psu * dt_psu[, sum(t_hat)];\n\n  # Equation 13 in Ene et al. (2016)\n  v_hat <- dt_psu[, est_var_succ_diff(y = mean_t_hat, N = NI, n = nI, w = w_i)];\n\n  return(list(t_hat = t_hat, v_hat = v_hat));\n}\n\n#'Model-assisted estimators for two-stage simple random sampling\n#'\n#'The population is separated into a set of contiguous PSUs (clusters/strips),\n#'which are sampled in the first stage. SSUs are selected from the selected PSUs\n#'in the second stage independently. The estimators correspond to case C in\n#'Särndal et al. (1992), where auxiliaries are avalaible for SSUs in the\n#'selected PSUs. Modelling is done at the element level.\n#'\n#'@param dt_sample A data.table object containing information about the PSUs and\n#'  SSUs selected in the two sampling stages.\n#'@param key_var Name of the variable identifying the PSUs. Must be present in\n#'  both data.tables.\n#'@param y Quoted name of the variable storing the observed values of the study\n#'  variable.\n#'@param res Quoted name of the variable stroing the residuals between observed\n#'  and predicted values.\n#'@param t_pred Quoted name of the variable storing predicted PSU totals\n#'@param N_i quoted name of the variable storing the size of the PSUs\n#'@param n_i quoted name of the variable storing the number of selected SSUs in\n#'  each PSUs\n#'@param NI Number of PSUs\n#'@param nI PSU sample size\n#'\n#'@details See S?rndal et al. (1992), equation 8.9.7 for the estimation of\n#'  the population total and Equation 8.9.27 for variance estimation. The\n#'  variance estimator may under some circumstances deliver negative estimates.\n#'  Therefore, an alternative variance estimator that ignores the variation that\n#'  comes from estimating PSU totals is provided as an alternative (Särndal et\n#'  al., p. 154, Equation 4.6.2).\n#'\n#'@return A named list containing estimates for the total and its variance\n#'  estimate\n#'\n#'@references S?rndal, C. E., B. Swensson and J. Wretman (1992). Model assisted\n#'  survey sampling. New York, Springer-Verlag.\n#'\n#'@import data.table\n#'@export\nest_ts_ma_srswor <- function(dt_samp, NI, nI,\n                             id_psu = 'id',\n                             y = quote(y),\n                             N_i = quote(N_i),\n                             n_i = quote(n_i),\n                             res = quote(res),\n                             t_pred = quote(t_pred)) {\n\n  dt_psu <- get_psu_stats(dt_samp = dt_samp, y = y, id_psu = id_psu, res = res);\n  dt_psu <- dt_psu[dt_samp[,\n                           list(t_pred = max(eval(t_pred)),\n                                N_i = max(eval(N_i)),\n                                n_i = max(eval(n_i))),\n                           keyby = id_psu]];\n\n  dt_psu[, t_hat := N_i/n_i * sum_y];\n  dt_psu[is.nan(t_hat) == TRUE, t_hat := 0];\n\n  dt_psu[, v_y := N_i^2*(1/n_i - 1/N_i) * var_y];\n  dt_psu[is.na(v_y) == TRUE, v_y := 0];\n\n  dt_psu[, t_res := N_i/n_i * sum_res];\n  dt_psu[is.nan(t_res) == TRUE, t_res := 0];\n\n  dt_psu[, ':='(t_hat_ma = t_pred + t_res,\n                v_res = N_i^2*(1/n_i - 1/N_i)*var_res)];\n  dt_psu[is.na(v_res) == TRUE, v_res := 0];\n\n  # Equation 8.9.7\n  t_hat <- NI/nI * dt_psu[, sum(t_hat_ma)];\n\n  # Equation 8.9.27\n  v_psu <- NI^2*(1/nI - 1/NI)*dt_psu[, var(t_hat) - 1/nI*sum(v_y)];\n  v_ssu <- (NI/nI)^2*dt_psu[, sum(v_res)];\n  v_hat <- v_psu + v_ssu;\n\n  v_hat_alt <- NI^2*1/nI*dt_psu[, var(t_hat_ma)];\n\n  return(list(t_hat = t_hat, v_hat = v_hat, v_hat_alt = v_hat_alt));\n}\n\n#'Horvitz-Thompson estimators for two-stage simple random sampling\n#'\n#'The population is separated into a set of contiguous PSUs (clusters/strips),\n#'which are sampled in the first stage. SSUs are selected from the selected PSUs\n#'in the second stage independently.\n#'\n#'@param dt_sample A data.table object containing information about the PSUs and\n#'  SSUs selected in the two sampling stages.\n#'@param key_var Name of the variable identifying the PSUs. Must be present in\n#'  both data.tables.\n#'@param y Quoted name of the variable storing the observed values of the study\n#'  variable.\n#'@param N_i quoted name of the variable storing the size of the PSUs\n#'@param n_i quoted name of the variable storing the number of selected SSUs in\n#'  each PSUs\n#'@param NI Number of PSUs\n#'@param nI PSU sample size\n#'\n#'  @details See S?rndal et al. (1992), equation 4.3.21 for the estimation of\n#'  the population total and Equation 4.3.22 for variance estimation. The\n#'  variance estimator may under some circumstances deliver negative estimates.\n#'  Therefore, an alternative variance estimator that ignores the variation that\n#'  comes from estimating PSU totals is provided as an alternative (Särndal et\n#'  al., p. 154, Equation 4.6.2).\n#'\n#'@return A named list containing estimates for the total and its variance\n#'  estimate\n#'\n#'@references Särndal, C. E., B. Swensson and J. Wretman (1992). Model assisted\n#'  survey sampling. New York, Springer-Verlag.\n#'\n#'@import data.table\n#'@export\nest_ts_srswor <- function(dt_samp, NI, nI,\n                          id_psu = 'id',\n                          y = quote(y),\n                          N_i = quote(N_i),\n                          n_i = quote(n_i)) {\n\n  dt_psu <- get_psu_stats(dt_samp = dt_samp, y = y, id_psu = id_psu);\n  dt_psu <- dt_psu[dt_samp[,\n                           list(N_i = max(N_i),\n                                n_i = max(n_i)),\n                           keyby = id_psu]];\n\n  dt_psu[, t_hat := N_i/n_i * sum_y];\n  dt_psu[is.nan(t_hat) == TRUE, t_hat := 0];\n\n  dt_psu[, v_y := N_i^2*(1/n_i - 1/N_i) * var_y];\n  dt_psu[is.na(v_y) == TRUE, v_y := 0];\n\n  # Equation 4.3.21\n  t_hat <- NI/nI * dt_psu[, sum(t_hat)];\n\n  # Equation 4.3.23\n  v_psu <- NI^2*(1/nI - 1/NI)*dt_psu[, var(t_hat)];\n  v_ssu <- NI/nI*dt_psu[, sum(v_y)];\n  v_hat <- v_psu + v_ssu;\n\n  # Equation 4.6.2\n  v_hat_alt <- NI^2*1/nI*dt_psu[, var(t_hat)];\n\n  return(list(t_hat = t_hat, v_hat = v_hat, v_hat_alt = v_hat_alt));\n}\n\n#'Model-based inference for two-stage surveys\n#'\n#'The population is separated into a set of contiguous PSUs (clusters/strips),\n#'which are sampled in the first stage. SSUs are selected from the selected PSUs\n#'in the second stage independently.\n#'\n#'@param dt_sample A data.table object containing information about the PSUs and\n#'  SSUs selected in the two sampling stages.\n#'@param X Matrix containing the auxiliary variables (observations stored in\n#'  rows, variables in columns). Can be a column vector of auxiliary averages in\n#'  case linear models are used.\n#'@param parm_cov Model parameter covariance matrix.\n#'@param t_pred Quoted name of the variable storing predicted PSU totals\n#'@param N Population size (Numbr of SSUs in the population).\n#'@param NI Number of PSUs\n#'@param nI PSU sample size\n#'\n#'@details See Ståhl et al. (2011).\n#'\n#'@return A named list containing estimates for the total and its variance\n#'  estimate\n#'\n#'@references Ståhl, G., S. Holm, T. G. Gregoire, T. Gobakken, E. Næsset and R.\n#'  Nelson (2011). \"Model-based inference for biomass estimation in a LiDAR\n#'  sample survey in Hedmark County, Norway.\" Canadian Journal of Forest\n#'  Research 41: 96-107.\n#'\n#'@import data.table\n#'@export\nest_ts_mb <- function(dt_samp, X, parm_cov, t_pred = quote(t_pred), N, NI, nI) {\n  t_hat = NI/nI*dt_samp[, sum(eval(t_pred))];\n  v_pb <- NI^2*(1/nI - 1/NI)*dt_samp[, var(t_pred)]; # Assuming random selection of clusters (PSUs)\n  v_mb <- X%*%parm_cov%*%t(X);\n\n  v_hat <- v_pb + N^2*v_mb;\n\n  return(list(t_hat = t_hat, v_hat = v_hat));\n}\n",
    "created" : 1466450323885.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3375361499",
    "id" : "A5B18D99",
    "lastKnownWriteTime" : 1472481613,
    "last_content_update" : 1472481613189,
    "path" : "~/LiDAR_Satellite/R/restimate/R/two_stage_estimators.R",
    "project_path" : "R/two_stage_estimators.R",
    "properties" : {
        "chunk_rendered_width" : "650"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}